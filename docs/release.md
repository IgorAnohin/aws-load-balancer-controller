# AWS Load Balancer Controller Release Process

# Инструкция по релизу новой версии

## Версионирование

Используется следующая схема версионирования - <upstream_version>-ROCKIT<X>. Где X - инкрементируется с каждым новым релизом. Например при текущей версии апстрима v0.5.0 и текущей версии этой репы v0.5.0-ROCKIT1 следующая версия будет v0.5.0-ROCKIT2. При обновлении версии апстрима, например до v0.6.0, успешный ребейз на новый апстрим будет результирован в версию v0.6.0-ROCKIT2. Предполагается суппорт только актуальных версий.

Версии обозначаются гит тегами. Тегируется main ветка используя механизм релизов гитхаба. При создании нового релиза, описание релиза заполняется краткой сводкой изменений в новом релизе. После создания нового релиза (и тега), тег забирается на локалку (git pull upstream main --tags) и выполняется ручная сборка и публикация артефактов.

## Пререквизиты

В системе должны быть установлены следующие компоненты:
- `docker(c buildx)`
- [`kustomize`](https://github.com/kubernetes-sigs/kustomize)

## Подготовка

Перед началом сборки артефактов необходимо обновить версию приложения в переменной `VERSION` в `Makefile`
Запустить юнит тесты, инструкция находится в `docs/test.md`

## Артефакты

Релизными артефактами этой репы является докер имадж и deployment конфиги для kubernetes. При любом новом релизе необходимо обновлять kustomization.yaml и генерить бандл:
- make-target create-bundle обновит kustomization и соберет бандл по пути config/k_bundle.yaml 
```
make create-bundle
```

### Сборка образа

Выполнить make-target docker-build-w-buildx для построения образа в docker registry.
```
make docker-build-w-buildx
```

### Релиз образа
Для релиза образа необходимо:
- Установить переменную окружения `RELEASE_REGISTRIES` со значением в виде списка репозиториев в формате `<registry-1> <registry-2> ...`
- Выполнить make-target docker-push-w-buildx для построения и пуша образа в docker registry.
```
make docker-push-w-buildx RELEASE_REGISTRIES="<registry-1> <registry-2> ..."
```